function animate(){animationQueue.empty()?nodesLayer.onFrame=null:null==nodesLayer.onFrame&&(nodesLayer.onFrame=animationLoop)}function animationLoop(e){animationQueue.animate(),animationQueue.empty()&&(nodesLayer.onFrame=null),e.count>=1e3&&(nodesLayer.onFrame=null)}function testDrawPoints(){}function updateNodesPosition(){$(roads).each(function(e,t){t.updatePosition()})}function pointEnter(e){e.target.fillColor="blue"}function pointLeave(e){e.target.fillColor="red"}function pointPressed(e){e.target.fillColor="red",console.log(e.target.OSM)}function isPathInView(e){return e.position.x>0&&e.position.x<$("#testcanvas").width()&&e.position.y>0&&e.position.y<$("#testcanvas").height()?!0:!0}function updatePositionText(){$("#position").html(MAPAPP.MAP.current_center.lat.toFixed(6)+", "+MAPAPP.MAP.current_center.lon.toFixed(6))}function testDrawNodes(e){$(e).each(function(e,t){"node"==t.type?nodeObjs[t.id]=t:"way"==t.type&&wayObjsArray.push(t)}),$(wayObjsArray).each(function(e,t){var n=new MAPAPP.OBJECTS.ROAD;$(t.nodes).each(function(e,t){n.addPoint(new MAPAPP.OBJECTS.POINT(nodeObjs[t].lat,nodeObjs[t].lon))}),roads.push(n)}),paper.view.draw()}function test(){console.log("API CALL..."),$.get("http://overpass-api.de/api/interpreter?data=[out:json];(node(55.675212,12.567147,55.677152,12.569317);rel(bn)->.x;way(55.675212,12.567147,55.677152,12.569317);node(w)->.x;);out meta;",function(e){console.log("...DONE!"),console.log(e),testDrawNodes(e.elements)})}var nodesLayer,uiLayer;$(document).ready(function(e){paper.install(window);var t=e("#testcanvas")[0];paper.setup(t);var n=new Tool;n.onMouseDrag=function(e){animationQueue.clear();var t=new MAPAPP.OBJECTS.WORLD_COOR(MAPAPP.MAP.current_center.lat-MAPAPP.MAP.pixels_to_world_degrees(e.event.movementY),MAPAPP.MAP.current_center.lon-MAPAPP.MAP.pixels_to_world_degrees(e.event.movementX));MAPAPP.MAP.current_center=t,updateNodesPosition(),updatePositionText()},n.onMouseDown=function(e){if(e.event.detail>1){var t=MAPAPP.MAP.map_to_world_coor(new MAPAPP.OBJECTS.MAP_COOR(e.event.x,e.event.y));MAPAPP.MAP.goto_position(t,!0)}else if(1==e.event.altKey){var t=MAPAPP.MAP.map_to_world_coor(new MAPAPP.OBJECTS.MAP_COOR(e.event.x,e.event.y));console.log(t.lat.toFixed(6)+", "+t.lon.toFixed(6))}},e("#zoom_in").click(function(){MAPAPP.MAP.zoom_in(null,!0)}),e("#zoom_out").click(function(){MAPAPP.MAP.zoom_out(null,!0)}),nodesLayer=new Layer,uiLayer=new Layer,uiLayer.activate();var o=new Path.Circle(new Point(e("#testcanvas").width()/2,e("#testcanvas").height()/2),5);o.fillColor="black",nodesLayer.activate(),updatePositionText(),animationQueue=new MAPAPP.ANIMATION_QUEUE,test(),paper.view.draw()});var animationQueue,MAPAPP={};MAPAPP.OBJECTS={},MAPAPP.OBJECTS.WORLD_COOR=function(e,t){return{lat:parseFloat(e),lon:parseFloat(t)}},MAPAPP.OBJECTS.MAP_COOR=function(e,t){return{x:e,y:t}},MAPAPP.OBJECTS.POINT=function(e,t){this.worldCoor=null,this.position=function(){return null!=this.worldCoor?MAPAPP.MAP.world_to_map_coor(this.worldCoor):[0,0]},void 0!=e&&void 0!=t&&(this.worldCoor=new MAPAPP.OBJECTS.WORLD_COOR(e,t))},MAPAPP.OBJECTS.ROAD=function(){this.path=[],this.addPoint=function(e){this.path.push(e),this.createLine()},this.createLine=function(){null!=this.paperLine&&this.paperLine.remove();var e=new Path;e.strokeColor="red",e.strokeWidth=2,$(this.path).each(function(t,n){if(null!=n.worldCoor){var o=n.position();n.paperPoint=e.add([o.x,o.y])}else console.log("error..1214")}),this.paperLine=e},this.updatePosition=function(){$(this.path).each(function(e,t){var n=t.position();t.paperPoint.point.x=n.x,t.paperPoint.point.y=n.y}),this.paperLine.strokeWidth=2},this.paperLine=null},MAPAPP.ANIMATION_QUEUE=function(){this.queue=[],this.then=[],this.push=function(e){for(var t=!1,n=0;n<this.queue.length;n++)null!=this.queue[n].id&&this.queue[n].id==e.id&&(1==e.queue?t=!0:this.remove(this.queue[n]));t?this.then.push(e):(this.queue.push(e),e.init())},this.remove=function(e){this.queue.splice(this.queue.indexOf(e),1),this.length--},this.animate=function(){for(var e=[],n=0;n<this.queue.length;n++)0==this.queue[n].animate()&&e.push(this.queue[n]);var o=!1;for(n=0;n<e.length;n++)for(this.remove(e[n]),t=0;t<this.then.length;t++)if(this.then[t].id==e[n].id){this.push(this.then[t]),o=this.then[t];break}0!=o&&this.then.splice(this.then.indexOf(o),1)},this.clear=function(){this.queue=[]},this.empty=function(){return this.queue.length>0?!1:!0}},MAPAPP.ANIMATION=function(){this.id=null,this.frame=0,this.length=0,this.queue=!1,this.init=function(){return!1},this.animate=function(){return this.frame++,this.frame>this.length?!1:this.animateFrame()},this.animateFrame=function(){return!1}},MAPAPP.MAP={},MAPAPP.MAP.zoom_level=1,MAPAPP.MAP.current_center=new MAPAPP.OBJECTS.WORLD_COOR(55.676097,12.568337),MAPAPP.MAP.pixels_to_world_degrees=function(e){return e/1e5*MAPAPP.MAP.zoom_level},MAPAPP.MAP.world_degrees_to_pixels=function(e){return 1e5*e/MAPAPP.MAP.zoom_level},MAPAPP.MAP.world_to_map_coor=function(e){return new MAPAPP.OBJECTS.MAP_COOR(MAPAPP.MAP.world_degrees_to_pixels(e.lon-MAPAPP.MAP.current_center.lon)+$("#testcanvas").width()/2,MAPAPP.MAP.world_degrees_to_pixels(e.lat-MAPAPP.MAP.current_center.lat)+$("#testcanvas").height()/2)},MAPAPP.MAP.map_to_world_coor=function(e){return new MAPAPP.OBJECTS.WORLD_COOR(MAPAPP.MAP.current_center.lat+MAPAPP.MAP.pixels_to_world_degrees(e.y-$("#testcanvas").height()/2),MAPAPP.MAP.current_center.lon+MAPAPP.MAP.pixels_to_world_degrees(e.x-$("#testcanvas").width()/2))},MAPAPP.MAP.goto_position=function(e,t){if(1==t){var t=new MAPAPP.ANIMATION;t.length=15,t.id="goto",t.queue=!0,t.init=function(){t.lon_inteval=(e.lon-MAPAPP.MAP.current_center.lon)/t.length,t.lat_inteval=(e.lat-MAPAPP.MAP.current_center.lat)/t.length},t.animateFrame=function(){return MAPAPP.MAP.current_center=new MAPAPP.OBJECTS.WORLD_COOR(MAPAPP.MAP.current_center.lat+t.lat_inteval,MAPAPP.MAP.current_center.lon+t.lon_inteval),updateNodesPosition(),updatePositionText(),!0},animationQueue.push(t),animate()}else MAPAPP.MAP.current_center=e,updateNodesPosition(),updatePositionText()},MAPAPP.MAP.set_zoom=function(e,t){if(0>=e&&(e=.1),1==t){var t=new MAPAPP.ANIMATION;t.length=15,t.id="zoom";var n=(MAPAPP.MAP.zoom_level-e)/t.length;t.animateFrame=function(){MAPAPP.MAP.zoom_level-=n,updateNodesPosition()},animationQueue.push(t),animate()}else MAPAPP.MAP.zoom_level=e,updateNodesPosition(),paper.view.draw()},MAPAPP.MAP.zoom_in=function(e,t){var n=void 0==e||null==e?1:e;this.set_zoom(MAPAPP.MAP.zoom_level-n,t)},MAPAPP.MAP.zoom_out=function(e,t){var n=void 0==e||null==e?1:e;this.set_zoom(MAPAPP.MAP.zoom_level+n,t)};var testPoints=[];testPoints.push(new MAPAPP.OBJECTS.WORLD_COOR(55.674442,12.566367)),testPoints.push(new MAPAPP.OBJECTS.WORLD_COOR(55.672842,12.563437)),testPoints.push(new MAPAPP.OBJECTS.WORLD_COOR(55.676097,12.568337)),paths=[],lines=[],roads=[];var nodeObjs={},wayObjs={},nodeObjsArray=[],wayObjsArray=[];